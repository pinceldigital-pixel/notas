<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Notas con Notificaciones</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#ffffff">
  <style>
    body { font-family: Arial, sans-serif; max-width: 600px; margin: auto; padding: 1rem; }
    h1 { text-align: center; }
    .note { border: 1px solid #ccc; padding: .5rem; margin-bottom: .5rem; border-radius: 5px; }
    button { margin-top: .3rem; }
  </style>
</head>
<body>
  <h1>ðŸ“’ Notas con Recordatorios</h1>

  <div>
    <input id="noteTitle" placeholder="TÃ­tulo" style="width:100%;padding:.5rem;">
    <textarea id="noteContent" placeholder="Contenido" style="width:100%;padding:.5rem;margin-top:.5rem;"></textarea>
    <input id="noteTime" type="datetime-local" style="width:100%;padding:.5rem;margin-top:.5rem;">
    <button onclick="addNote()">Agregar nota con recordatorio</button>
  </div>

  <div id="notesContainer"></div>

<script>
let notes = [];

// âœ… Registrar el Service Worker
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('./sw.js').catch(console.error);
}

// âœ… Pedir permiso para notificaciones al inicio
if ('Notification' in window) {
  Notification.requestPermission().then(perm => console.log('Permiso de notificaciÃ³n:', perm));
}

// Programar recordatorios en la pÃ¡gina
const timers = new Map();

function scheduleInPage(note) {
  clearInPage(note.id);
  if (!note.notificationTime || note.notificationTime <= Date.now()) return;
  const delay = note.notificationTime - Date.now();
  const t = setTimeout(() => {
    postNotificationMessage('show-now', {
      title: note.title || 'Recordatorio',
      body: note.content.substring(0, 100),
      tag: `note-${note.id}`,
      icon: './icons/icon-192.png'
    });
  }, delay);
  timers.set(note.id, t);
}

function clearInPage(id) {
  if (timers.has(id)) {
    clearTimeout(timers.get(id));
    timers.delete(id);
  }
}

function postNotificationMessage(type, payload){
  navigator.serviceWorker?.ready.then(reg => {
    if (reg.active) reg.active.postMessage({ type, payload });
  });
}

function addNote() {
  const title = document.getElementById('noteTitle').value;
  const content = document.getElementById('noteContent').value;
  const timeValue = document.getElementById('noteTime').value;
  if (!title && !content) return alert('EscribÃ­ algo primero ðŸ˜‰');

  const note = {
    id: Date.now(),
    title,
    content,
    notificationTime: timeValue ? new Date(timeValue).getTime() : null
  };
  notes.push(note);
  renderNotes();
  scheduleInPage(note);
  document.getElementById('noteTitle').value = '';
  document.getElementById('noteContent').value = '';
  document.getElementById('noteTime').value = '';
}

function deleteNote(id) {
  notes = notes.filter(n => n.id !== id);
  clearInPage(id);
  renderNotes();
}

function renderNotes() {
  const container = document.getElementById('notesContainer');
  container.innerHTML = '';
  notes.forEach(note => {
    const div = document.createElement('div');
    div.className = 'note';
    div.innerHTML = `<strong>${note.title}</strong><br>${note.content}<br>` +
      (note.notificationTime ? `<small>Recordatorio: ${new Date(note.notificationTime).toLocaleString()}</small><br>` : '') +
      `<button onclick="deleteNote(${note.id})">Borrar</button>`;
    container.appendChild(div);
  });
}
</script>

</body>
</html>
